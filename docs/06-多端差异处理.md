# 06 多端差异处理

## 适用范围

- 同功能需兼容 H5、App、小程序等多端时使用。

## 规则

- 多端实现优先采用“统一 `uni.*` API + 条件编译”组合。
- 同路径同时存在 `.vue` 与 `.nvue` 时：非 App 端优先 `.vue`，App 端优先 `.nvue`。
- 平台差异统一收敛在适配层，不把分支散落到页面。
- 使用条件编译控制端能力：`#ifdef` / `#ifndef`。
- 条件编译不仅用于 `js/vue`，也可用于 `nvue/css/pages.json/manifest.json/uts`，配置侧差异优先在配置文件收敛。
- 仅当编译到目标端时条件代码才会生效，未命中的代码在构建产物中会被移除。
- 对不可用能力提供降级方案与用户提示。
- 端特定逻辑写注释说明原因与影响范围。
- 涉及 `app-nvue` 页面时，布局优先 `flex`，减少跨端样式偏差。
- 端差异静态资源放 `static/<platform>/` 子目录（如 `web`、`app`、`mp-weixin`），避免资源互相污染。
- `onPageScroll` 在 `nvue` 暂不支持，滚动交互能力需按端降级设计。
- `uni-app x` 场景下 `dialogPage` 不影响页面栈和标准路由路径，按普通页面路径规则维护即可。
- 条件编译宏优先使用平台专属标识（如 `APP-PLUS`、`APP-ANDROID`、`APP-IOS`、`H5`、`MP-WEIXIN`），避免使用宽泛宏导致误命中。
- `npm` 模块需评估跨端兼容性：大量仅依赖 `DOM/window` 的包通常只适配 H5。
- 优先使用 uni 插件市场里标注“多端可用”的库，减少自行兼容成本。
- 被 `import` 的 `json` 内条件编译会按目标平台生效，不同端读取结果可能不同。
- 支付宝小程序组件中 `image` 标签不支持相对路径，静态资源需使用绝对路径或脚本导入绑定。
- App 原生插件（Android/iOS）与鸿蒙扩展是两条不同路线：前者走 `native-plugin`，后者优先走 UTS/鸿蒙专题能力。
- 非 H5 端不提供浏览器全局对象（如 `window/document/navigator`），跨端代码禁止直接依赖这些对象。
- CORS 约束主要发生在 H5 浏览器环境；普通小程序/App 的 `uni.request` 默认不走浏览器同源策略。
- uni-app JS 以 ECMAScript 为基础并扩展 `uni` API；端能力调用优先走 `uni` 与适配层。
- App 端 JS 在独立引擎执行，页面渲染区分 `vue`（webview）与 `nvue`（原生视图）两种机制。
- 样式能力按端区分：`vue` 页面支持常规 web CSS；`nvue/uvue` 样式能力受原生渲染约束。
- 在 `template/style` 写条件编译时，注释语法必须使用 HTML/CSS 注释，不使用 JS 注释写法。
- 静态资源条件编译通过目录约定实现：`/static/<平台目录>/...`；`static` 内文件本身不支持 `#ifdef`。
- `js` 运行时平台判断（如 `uni.getSystemInfoSync().platform`）只用于运行逻辑分支，不替代编译期裁剪。
- `plus.*` 与 `plus.os.name` 仅在 App-Plus 可用，调用前需确保运行在 App 端并等待 `plusready`。
- H5 端内嵌 `web-view`、`renderjs`、iOS `WKWebView` 等浏览器内核场景仍会受到 CORS 约束。

## 示例

- 分享、定位、支付等能力走 `platform adapter` 封装。
- H5 不支持能力时给出可替代路径。
- 小程序差异逻辑集中在适配层 `#ifdef MP-WEIXIN` 代码块中。
- 小程序专用图片放 `static/mp-weixin/`，H5 专用资源放 `static/web/`。
- `pages.json` 中按端拆分页面与样式配置，减少业务页面内平台分支。
- 需要滚动联动时，在 `nvue` 端改用原生可用方案，不直接复用 `onPageScroll` 逻辑。
- `dialogPage` 弹出页仅影响展示层，不改变主页面 `navigateTo` 路由约定。
- 选择依赖前先验证在 `H5 + 小程序 + App` 的最低目标端是否可运行。
- 同一份 `json` 在 H5/App 打包后字段可按条件编译产生差异。
- 小程序端图片展示统一走 `/static/...` 或 `import` 绑定，避免组件内相对路径差异。
- 需要原生能力时，Android/iOS 走插件封装，鸿蒙端按 UTS 能力适配实现同等接口。
- 跨端环境检查统一使用条件编译与能力判断，不以 `window` 存在性作为主判断依据。
- App 端读取运行平台前先等待 `plusready`，再基于 `plus.os.name` 区分 Android/iOS 行为。
- H5 请求报跨域时优先确认是否处于浏览器内核链路（页面、web-view、renderjs），再决定代理或服务端改造。
- App 端遇到样式差异时，先确认页面是 `vue` 还是 `nvue`，再按对应渲染机制排查。
- `nvue` 页面布局优先 `flex + px/rpx`，避免直接复用 `vue` 页面的 web 特性单位与选择器。

## 反例

- 同一页面存在大量端判断，导致主流程不可读。
- 直接调用端 API，不判断权限和可用性。
- `nvue` 页面复用大量 web 布局写法，导致渲染不一致。
- 多端共用同一路径静态资源，发布后互相覆盖或引用错误。
- 未判断端能力就统一依赖 `onPageScroll`，导致部分端无效。
- 把 `dialogPage` 当成独立路由栈使用，导致返回逻辑混乱。
- 直接引入只支持浏览器环境的库到小程序/App，运行时报 `window` 或 `document` 未定义。
- 误以为多端读取到的 `json` 完全一致，导致端上逻辑分支判断错误。
- 支付宝小程序中沿用 H5 相对图片路径，导致页面图片空白。
- 未区分鸿蒙与 Android/iOS 实现路线，直接复用插件流程导致端能力接入失败。
- 在小程序/App 直接访问 `window`、`document`，导致运行时报未定义错误。
- 把 `vue` 页面 CSS 兼容问题按 `nvue` 机制处理，导致定位方向错误。
- 在 `nvue` 页面直接使用 `vh/vw/rem` 等 web 依赖单位，出现端上布局偏差。
- 在 `style/template` 里使用 `// #ifdef` 注释，导致条件编译块不生效。
- 试图在 `static` 文件内容里写 `#ifdef`，导致资源未按预期区分平台。
- 在 H5/小程序直接访问 `plus.os.name`，导致运行时报 `plus is not defined`。
- 把 H5 跨域问题当成小程序/App `uni.request` 的通用问题处理，导致排查方向错误。

## 检查项

- 端差异是否集中管理。
- 条件编译块是否最小化且可读。
- 降级路径是否可验证、可回退。
- 页面主流程中是否存在大量平台分支判断。
- 端特有资源是否已按平台目录隔离。
- 滚动交互在 `nvue` 等受限端是否有替代方案。
- `uni-app x` 页面弹窗能力是否与普通路由职责区分清楚。
- 关键第三方依赖是否有跨端兼容结论与替代方案。
- `json` 条件编译差异是否已在目标端验证。
- `pages.json/manifest.json` 的平台差异是否通过条件编译管理而非页面内硬编码。
- 资源路径在支付宝小程序组件场景是否已通过真机验证。
- 原生能力是否已区分 Android/iOS 与鸿蒙的实现路线与测试清单。
- 是否存在直接依赖浏览器全局对象的跨端代码。
- App 页面渲染问题是否已按 `vue/nvue` 机制区分排查。
- 样式实现是否已按 `vue/nvue/uvue` 能力边界做差异化设计。
- 样式和模板中的条件编译注释语法是否正确（HTML/CSS 注释而非 JS 注释）。
- App 端 `plus` 能力调用是否包含端判断与 `plusready` 时机控制。
- 是否已明确当前请求链路是否受浏览器 CORS 约束（H5/web-view/renderjs/WKWebView）。

## 来源

- 官方教程（2026-02-11 查阅）：https://uniapp.dcloud.net.cn/tutorial/
- 官方教程（2026-02-11 查阅）：https://uniapp.dcloud.net.cn/tutorial/project.html
- 官方教程（2026-02-11 查阅）：https://uniapp.dcloud.net.cn/tutorial/page.html
- 官方教程（2026-02-11 查阅）：https://uniapp.dcloud.net.cn/tutorial/page-path.html
- 官方教程（2026-02-11 查阅）：https://uniapp.dcloud.net.cn/tutorial/page-script.html
- 官方教程（2026-02-11 查阅）：https://uniapp.dcloud.net.cn/tutorial/page-json.html
- 官方教程（2026-02-11 查阅）：https://uniapp.dcloud.net.cn/tutorial/page-static-assets.html
- 官方教程（2026-02-11 查阅）：https://uniapp.dcloud.net.cn/plugin/native-plugin.html
- 官方教程（2026-02-11 查阅）：https://uniapp.dcloud.net.cn/tutorial/harmony/native-api.html
- 官方教程（2026-02-11 查阅）：https://uniapp.dcloud.net.cn/tutorial/harmony/history.html
- 官方教程（2026-02-11 查阅）：https://uniapp.dcloud.net.cn/tutorial/syntax-js.html
- 官方教程（2026-02-11 查阅）：https://uniapp.dcloud.net.cn/tutorial/syntax-css.html
- 官方教程（2026-02-11 查阅）：https://uniapp.dcloud.net.cn/tutorial/platform.html
