# 06 多端差异处理

## 适用范围

- 同功能需兼容 H5、App、小程序等多端时使用。

## 规则

- 多端实现优先采用“统一 `uni.*` API + 条件编译”组合。
- 同路径同时存在 `.vue` 与 `.nvue` 时：非 App 端优先 `.vue`，App 端优先 `.nvue`。
- 平台差异统一收敛在适配层，不把分支散落到页面。
- 使用条件编译控制端能力：`#ifdef` / `#ifndef`。
- 对不可用能力提供降级方案与用户提示。
- 端特定逻辑写注释说明原因与影响范围。
- 涉及 `app-nvue` 页面时，布局优先 `flex`，减少跨端样式偏差。
- 端差异静态资源放 `static/<platform>/` 子目录（如 `web`、`app`、`mp-weixin`），避免资源互相污染。
- `onPageScroll` 在 `nvue` 暂不支持，滚动交互能力需按端降级设计。
- `uni-app x` 场景下 `dialogPage` 不影响页面栈和标准路由路径，按普通页面路径规则维护即可。
- `npm` 模块需评估跨端兼容性：大量仅依赖 `DOM/window` 的包通常只适配 H5。
- 优先使用 uni 插件市场里标注“多端可用”的库，减少自行兼容成本。
- 被 `import` 的 `json` 内条件编译会按目标平台生效，不同端读取结果可能不同。

## 示例

- 分享、定位、支付等能力走 `platform adapter` 封装。
- H5 不支持能力时给出可替代路径。
- 小程序差异逻辑集中在适配层 `#ifdef MP-WEIXIN` 代码块中。
- 小程序专用图片放 `static/mp-weixin/`，H5 专用资源放 `static/web/`。
- 需要滚动联动时，在 `nvue` 端改用原生可用方案，不直接复用 `onPageScroll` 逻辑。
- `dialogPage` 弹出页仅影响展示层，不改变主页面 `navigateTo` 路由约定。
- 选择依赖前先验证在 `H5 + 小程序 + App` 的最低目标端是否可运行。
- 同一份 `json` 在 H5/App 打包后字段可按条件编译产生差异。

## 反例

- 同一页面存在大量端判断，导致主流程不可读。
- 直接调用端 API，不判断权限和可用性。
- `nvue` 页面复用大量 web 布局写法，导致渲染不一致。
- 多端共用同一路径静态资源，发布后互相覆盖或引用错误。
- 未判断端能力就统一依赖 `onPageScroll`，导致部分端无效。
- 把 `dialogPage` 当成独立路由栈使用，导致返回逻辑混乱。
- 直接引入只支持浏览器环境的库到小程序/App，运行时报 `window` 或 `document` 未定义。
- 误以为多端读取到的 `json` 完全一致，导致端上逻辑分支判断错误。

## 检查项

- 端差异是否集中管理。
- 条件编译块是否最小化且可读。
- 降级路径是否可验证、可回退。
- 页面主流程中是否存在大量平台分支判断。
- 端特有资源是否已按平台目录隔离。
- 滚动交互在 `nvue` 等受限端是否有替代方案。
- `uni-app x` 页面弹窗能力是否与普通路由职责区分清楚。
- 关键第三方依赖是否有跨端兼容结论与替代方案。
- `json` 条件编译差异是否已在目标端验证。

## 来源

- 官方教程（2026-02-11 查阅）：https://uniapp.dcloud.net.cn/tutorial/
- 官方教程（2026-02-11 查阅）：https://uniapp.dcloud.net.cn/tutorial/project.html
- 官方教程（2026-02-11 查阅）：https://uniapp.dcloud.net.cn/tutorial/page.html
- 官方教程（2026-02-11 查阅）：https://uniapp.dcloud.net.cn/tutorial/page-path.html
- 官方教程（2026-02-11 查阅）：https://uniapp.dcloud.net.cn/tutorial/page-script.html
- 官方教程（2026-02-11 查阅）：https://uniapp.dcloud.net.cn/tutorial/page-json.html
