# 07 打包发布

## 适用范围

- 构建环境配置、发版流程、回滚策略定义时使用。

## 规则

- 环境变量按 `dev/test/prod` 分离，禁止混用。
- 发布前固定执行：类型检查、构建、关键路径冒烟。
- TypeScript 项目发布前必须执行一次全量类型检查（如 `vue-tsc --noEmit`），禁止仅依赖运行时验证。
- 版本号与变更记录同步，确保可追溯。
- 保留回滚策略：最近稳定包、配置快照、数据兼容说明。
- `static` 目录按“整目录拷贝”处理，发布前清理未使用资源。
- 样式资源（`css/scss/less`）不放 `static`，避免无法按引用裁剪。
- App 发行包需关注 `static` 体积，避免首次启动性能下降。
- 使用 `npm` 依赖时，确认 `node_modules` 位于项目根目录（不放到 `src` 或子目录）。
- 发布前对新增依赖做端兼容检查，标记“H5-only”包并给出降级或替代方案。
- 从大型 `json` 导入配置时优先按需解构导入，减少无关字段进入产物。
- `static` 目录资源会原样拷贝到产物目录；非 `static` 资源需被引用后才会进入编译产物。
- 老项目升级 Pinia 前先确认 HBuilderX 与运行基座版本；若基座过旧，优先整包更新而非直接依赖热更新包。
- Vue3 迁移后发布需显式确认构建参数：`sourcemap` 开关、微信小程序 `optimization.minified`、H5 `treeShaking` 策略。

## 示例

- 发布清单：配置校验 -> 构建 -> 冒烟 -> 发布 -> 监控。
- TypeScript 发布清单：依赖校验（`typescript/@dcloudio/types`）-> 类型检查 -> 构建 -> 冒烟。
- 高风险改动需附带回滚条件与负责人。
- 发布前执行静态资源盘点，移除无引用图片与历史文件。
- 发布前执行依赖审计：仅保留项目实际使用且跨端可运行的库。
- 发布前检查 `json` 导入方式：能按需解构的场景不使用整对象导入。
- 发布前检查非 `static` 资源是否都通过脚本导入或组件引用链路进入构建。
- App 发布前校验基座版本与 Pinia 兼容策略，旧基座场景走整包发布。
- 小程序发布前检查 `manifest.json` 的 `mp-weixin.optimization.minified` 是否符合目标环境。
- 调试阶段按需开启 `build.sourcemap`，发版前确认是否关闭并评估包体积影响。

## 反例

- 在本地临时改接口地址直接打正式包。
- 类型检查失败仍强行发版，导致端上运行时错误放大。
- 发版后无版本标识，无法定位问题来源。
- 把大量未使用资源留在 `static`，导致包体积持续膨胀。
- 把 `scss` 放进 `static`，导致资源管理和构建策略混乱。
- 把 `node_modules` 放在子目录，导致依赖解析和构建链路不稳定。
- 只需单字段却整份导入大型 `json`，导致包体积不必要增长。
- 把业务图片放在非 `static` 且未建立引用，打包后资源缺失。
- 旧基座项目升级 Pinia 后继续只发热更新包，导致线上状态管理异常。
- 迁移后忽略 `treeShaking/sourcemap/minified` 配置，导致真机白屏或产物异常膨胀。

## 检查项

- 构建配置是否与目标环境一致。
- 是否完成发布前检查并留档。
- 类型检查是否通过且关键 `tsconfig` 项（如 `types`）未被误删。
- 出现故障时是否可在限定时间内回滚。
- 是否完成 `static` 目录冗余资源清理。
- App 包体积是否在发布阈值内。
- `node_modules` 位置是否在项目根目录。
- 新增依赖是否已有跨端兼容结论。
- `json` 导入是否已按需解构以控制产物体积。
- 资源是否符合“`static` 原样拷贝、非 `static` 必须被引用”规则。
- 低版本 Android 设备是否完成关键页面 CSS 兼容冒烟（`vue` 页面重点验证）。
- App 目标版本是否已验证 Pinia 与运行基座的兼容关系（热更新/整包策略明确）。
- H5、小程序、App 的构建开关（`treeShaking/sourcemap/minified`）是否已按环境做差异化配置并留档。

## 来源

- 官方教程（2026-02-11 查阅）：https://uniapp.dcloud.net.cn/tutorial/project.html
- 官方教程（2026-02-11 查阅）：https://uniapp.dcloud.net.cn/tutorial/page-script.html
- 官方教程（2026-02-11 查阅）：https://uniapp.dcloud.net.cn/tutorial/page-json.html
- 官方教程（2026-02-11 查阅）：https://uniapp.dcloud.net.cn/tutorial/page-static-assets.html
- 官方教程（2026-02-11 查阅）：https://uniapp.dcloud.net.cn/tutorial/syntax-js.html
- 官方教程（2026-02-11 查阅）：https://uniapp.dcloud.net.cn/tutorial/vue3-pinia.html
- 官方教程（2026-02-11 查阅）：https://uniapp.dcloud.net.cn/tutorial/migration-to-vue3.html
- 官方教程（2026-02-11 查阅）：https://uniapp.dcloud.net.cn/tutorial/typescript-subject.html
